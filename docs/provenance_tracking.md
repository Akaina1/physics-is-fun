# Provenance Tracking Implementation

## Overview

Automatic build provenance tracking is now implemented. Every simulation run will capture and embed:

- **Git SHA** (8-character short hash)
- **Rust compiler version** (e.g., `rustc 1.75.0`)
- **Build timestamp** (ISO 8601 format, UTC)

This information appears in the **analysis report footer** when available.

## How It Works

### 1. Build Script (`build.rs`)

Captures provenance at **compile time**:

- Executes `git rev-parse --short=8 HEAD` to get current commit
- Captures `rustc --version` output
- Records current UTC timestamp using `chrono`
- Emits these as environment variables: `BUILD_GIT_SHA`, `BUILD_RUSTC_VERSION`, `BUILD_TIMESTAMP`

### 2. Render Module (`render.rs`)

Reads the compile-time environment variables using `option_env!()` and passes them to the manifest:

```rust
let git_sha = option_env!("BUILD_GIT_SHA").map(|s| s.to_string());
let rustc_version = option_env!("BUILD_RUSTC_VERSION").map(|s| s.to_string());
let build_timestamp = option_env!("BUILD_TIMESTAMP").map(|s| s.to_string());
```

### 3. Manifest (`transfer_maps.rs`)

Stores provenance in the `Manifest` struct (optional fields):

- `git_sha: Option<String>`
- `rustc_version: Option<String>`
- `build_timestamp: Option<String>`

Serialized to `manifest.json` alongside simulation parameters.

### 4. Analyzer (`generate_summary.rs`)

Reads provenance from `manifest.json` and displays it in the HTML report footer:

```html
ðŸ”§ Build Provenance Git SHA: abc12345 Rust Version: rustc 1.75.0 (hash) Build
Time: 2025-11-05T12:34:56Z
```

## Benefits

### For Development

- **Reproducibility**: Know exactly which code version generated each dataset
- **Debugging**: Correlate visual artifacts with specific commits
- **Validation**: Verify that production data uses the correct physics implementation

### For Research

- **Audit Trail**: Full lineage from source code to analysis results
- **Publication**: Include provenance in figure captions or supplementary materials
- **Collaboration**: Share datasets with confidence about their origin

## Implementation Files

| File                  | Purpose            | Changes                                            |
| --------------------- | ------------------ | -------------------------------------------------- |
| `build.rs`            | NEW - Build script | Captures git SHA, rustc version, timestamp         |
| `Cargo.toml`          | Config             | Added `build = "build.rs"` and `chrono` dependency |
| `transfer_maps.rs`    | Data export        | Added `with_provenance()` method to `Manifest`     |
| `render.rs`           | Simulation         | Captures `option_env!()` and passes to manifest    |
| `generate_summary.rs` | Analysis           | Displays provenance in HTML footer                 |

## Usage

### Normal Workflow

Just run your simulation as usual:

```powershell
cargo run --release --bin generate -- --preset balanced
```

Provenance is **automatically captured** at compile time and embedded in the output.

### Verification

Check the generated `manifest.json`:

```json
{
  "width": 1920,
  "height": 1080,
  ...
  "git_sha": "a1b2c3d4",
  "rustc_version": "rustc 1.75.0 (82e1608df 2023-12-21)",
  "build_timestamp": "2025-11-05T18:30:00Z"
}
```

Check the analysis report footer for the **"ðŸ”§ Build Provenance"** dropdown.

## Robustness

- **Graceful Degradation**: If git is unavailable or not a git repo, uses `"unknown"`
- **Optional Fields**: Fields are `Option<String>` and skip serialization if `None`
- **Backward Compatible**: Old `manifest.json` files without provenance still load correctly

## Future Enhancements

Possible additions:

- **Dirty Working Tree Flag**: Detect uncommitted changes (`git diff --quiet`)
- **Branch Name**: Include which branch the build came from
- **Build Machine**: Hostname or CI environment identifier
- **WASM Build Hash**: Separate tracking for web builds vs. native
- **Dependencies Hash**: Capture `Cargo.lock` checksum for full reproducibility

## Example Output

### In manifest.json

```json
{
  "width": 1920,
  "height": 1080,
  "preset": "balanced",
  "inclination": 45.0,
  "spin": 0.9,
  "orders": 3,
  "r_in": 2.321,
  "r_out": 20.0,
  "git_sha": "f7e8d9c2",
  "rustc_version": "rustc 1.75.0 (82e1608df 2023-12-21)",
  "build_timestamp": "2025-11-05T18:45:32Z",
  ...
}
```

### In analysis_report.html footer

```
Generated by Kerr Black Hole High-Precision Analyzer
Preset: balanced | 1920Ã—1080 | 3 orders | 45.0Â° inclination

ðŸ”§ Build Provenance â–¼
  Git SHA: f7e8d9c2
  Rust Version: rustc 1.75.0 (82e1608df 2023-12-21)
  Build Time: 2025-11-05T18:45:32Z
```

---

**Status**: âœ… Fully implemented and ready for use!
